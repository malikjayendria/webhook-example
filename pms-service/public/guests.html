<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Guests - PMS</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <div class="main-container fade-in">
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
          <a class="navbar-brand" href="/index.html">
            <i class="fas fa-hotel me-2"></i>
            PMS Dashboard
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/index.html"> <i class="fas fa-tachometer-alt me-1"></i>Dashboard </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/guests.html"> <i class="fas fa-users me-1"></i>Manage Guests </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/reservations.html"> <i class="fas fa-calendar-check me-1"></i>Manage Reservations </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/webhook-status.html"> <i class="fas fa-link me-1"></i>Webhook Status </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center mb-3">
            <i class="fas fa-users text-primary me-3" style="font-size: 2rem"></i>
            <div>
              <h1 class="h2 fw-bold mb-1">Manage Guests</h1>
              <p class="text-muted mb-0">Create, view, and manage guest profiles</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="row mb-4">
        <div class="col-md-6">
          <button class="btn btn-primary-custom btn-custom" onclick="openCreateModal()"><i class="fas fa-plus me-2"></i>Add New Guest</button>
        </div>
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or phone..." onkeyup="filterGuests()" />
          </div>
        </div>
      </div>

      <!-- Alert Container -->
      <div id="alertContainer" class="mb-4"></div>

      <!-- Guest List -->
      <div class="card-custom">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-users me-2 text-primary"></i>
            Guest List
            <span id="guestCount" class="badge bg-primary ms-2">0</span>
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="guestsTable">
              <thead class="table-light">
                <tr>
                  <th><i class="fas fa-hashtag me-1"></i>ID</th>
                  <th><i class="fas fa-user me-1"></i>Name</th>
                  <th><i class="fas fa-envelope me-1"></i>Email</th>
                  <th><i class="fas fa-phone me-1"></i>Phone</th>
                  <th><i class="fas fa-globe me-1"></i>Country</th>
                  <th><i class="fas fa-cogs me-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody id="guestsTableBody">
                <tr>
                  <td colspan="6" class="text-center py-4">
                    <div class="d-flex align-items-center justify-content-center">
                      <div class="loading-spinner me-2"></div>
                      <span>Loading guests...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal fade modal-custom" id="guestModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle"><i class="fas fa-user-plus me-2"></i>Add New Guest</h5>
            <button type="button" class="btn-close" onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <form id="guestForm">
              <input type="hidden" id="guestId" name="id" />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="name" class="form-label fw-bold"> <i class="fas fa-user me-1"></i>Name * </label>
                  <input type="text" class="form-control" id="name" name="name" required placeholder="Enter guest name" />
                  <div class="invalid-feedback">Please provide a valid name.</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label fw-bold"> <i class="fas fa-envelope me-1"></i>Email * </label>
                  <input type="email" class="form-control" id="email" name="email" required placeholder="Enter email address" />
                  <div class="invalid-feedback">Please provide a valid email.</div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="phone" class="form-label fw-bold"> <i class="fas fa-phone me-1"></i>Phone </label>
                  <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone number" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="dateOfBirth" class="form-label fw-bold"> <i class="fas fa-birthday-cake me-1"></i>Date of Birth </label>
                  <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="country" class="form-label fw-bold"> <i class="fas fa-globe me-1"></i>Country </label>
                  <input type="text" class="form-control" id="country" name="country" placeholder="Enter country" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-custom" onclick="closeModal()"><i class="fas fa-times me-1"></i>Cancel</button>
            <button type="submit" form="guestForm" class="btn btn-primary-custom btn-custom"><i class="fas fa-save me-1"></i>Save Guest</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "/api/v1";
      let allGuests = [];
      let searchTimeout = null;
      let isLoading = false;

      // Cache for API responses
      const apiCache = new Map();
      const CACHE_DURATION = 5000; // 5 seconds for development (shorter cache)

      // Load guests on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadGuests();
        setupRealTimeUpdates();
      });

      // Handle form submission
      document.getElementById("guestForm").addEventListener("submit", handleFormSubmit);

      // Setup real-time updates
      function setupRealTimeUpdates() {
        // Auto refresh every 15 seconds for development (less aggressive)
        setInterval(() => {
          if (!isLoading) {
            // Only refresh if not currently loading
            loadGuests(true); // Force refresh
          }
        }, 15000);

        // Listen for visibility change to refresh when tab becomes active
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden && !isLoading) {
            loadGuests(true);
          }
        });
      }

      // Optimized API call with caching
      async function apiCall(endpoint, options = {}, force = false) {
        const cacheKey = `${endpoint}_${JSON.stringify(options)}`;
        const now = Date.now();

        // Check cache first (skip if force refresh)
        if (!force && apiCache.has(cacheKey)) {
          const cached = apiCache.get(cacheKey);
          if (now - cached.timestamp < CACHE_DURATION) {
            console.log(`Using cached data for ${endpoint}`);
            return cached.data;
          }
          apiCache.delete(cacheKey);
        }

        console.log(`${force ? "Force refreshing" : "Fetching"} data from ${endpoint}`);

        try {
          const response = await fetch(endpoint, {
            ...options,
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          // Cache successful GET requests (only if not forced)
          if (!force && (!options.method || options.method === "GET")) {
            apiCache.set(cacheKey, {
              data: data,
              timestamp: now,
            });
            console.log(`Cached data for ${endpoint}`);
          }

          return data;
        } catch (error) {
          console.error("API call failed:", error);
          throw error;
        }
      }

      async function loadGuests(force = false) {
        if (isLoading && !force) return;

        isLoading = true;
        const loadingEl = document.querySelector(".loading-spinner");

        // Show loading state
        if (loadingEl) {
          loadingEl.style.display = "inline-block";
        }

        try {
          const data = await apiCall(`${API_BASE}/guests`, {}, force);

          if (data.success) {
            // Backend returns: { success: true, data: { data: [...], pagination: {...} } }
            allGuests = data.data?.data || [];
            renderGuests(allGuests);
            updateGuestCount();
          } else {
            throw new Error(data.error?.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error loading guests:", error);
          showAlert("Error loading guests: " + error.message, "error");

          // Show error state in table
          const tbody = document.getElementById("guestsTableBody");
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6" class="text-center py-4">
                  <div class="text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load guests. <button class="btn btn-sm btn-outline-primary" onclick="loadGuests(true)">Retry</button></p>
                  </div>
                </td>
              </tr>
            `;
          }
        } finally {
          // Always hide loading state
          isLoading = false;
          if (loadingEl) {
            loadingEl.style.display = "none";
          }
        }
      }

      function updateGuestCount() {
        const countEl = document.getElementById("guestCount");
        if (countEl) {
          countEl.textContent = allGuests.length;
        }
      }

      function renderGuests(guests) {
        const tbody = document.getElementById("guestsTableBody");
        const guestCount = document.getElementById("guestCount");

        // Update count
        guestCount.textContent = guests.length;

        tbody.innerHTML = "";

        if (guests.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-users fa-2x mb-2"></i>
                  <p>No guests found</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        guests.forEach((guest) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><code>${guest.id}</code></td>
            <td>
              <strong>${guest.name || "-"}</strong>
            </td>
            <td>
              <a href="mailto:${guest.email}" class="text-decoration-none">${guest.email}</a>
            </td>
            <td>${guest.phone || "-"}</td>
            <td>
              <span class="badge bg-light text-dark">
                <i class="fas fa-globe me-1"></i>${guest.country || "-"}
              </span>
            </td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editGuest(${guest.id})" title="Edit Guest">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteGuest(${guest.id})" title="Delete Guest">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function filterGuests() {
        // Clear previous timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // Debounce search for better performance
        searchTimeout = setTimeout(() => {
          const searchTerm = document.getElementById("searchInput").value.toLowerCase();
          const filteredGuests = allGuests.filter((guest) => (guest.name || "").toLowerCase().includes(searchTerm) || guest.email.toLowerCase().includes(searchTerm) || (guest.phone || "").toLowerCase().includes(searchTerm));
          renderGuests(filteredGuests);
        }, 300); // 300ms delay
      }

      function openCreateModal() {
        document.getElementById("modalTitle").innerHTML = '<i class="fas fa-user-plus me-2"></i>Add New Guest';
        document.getElementById("guestForm").reset();
        document.getElementById("guestId").value = "";

        const modal = new bootstrap.Modal(document.getElementById("guestModal"));
        modal.show();
      }

      function editGuest(id) {
        const guest = allGuests.find((g) => g.id == id);
        if (!guest) return;

        document.getElementById("modalTitle").innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit Guest';
        document.getElementById("guestId").value = guest.id;
        document.getElementById("name").value = guest.name || "";
        document.getElementById("email").value = guest.email;
        document.getElementById("phone").value = guest.phone || "";
        document.getElementById("dateOfBirth").value = guest.date_of_birth || "";
        document.getElementById("country").value = guest.country || "";

        const modal = new bootstrap.Modal(document.getElementById("guestModal"));
        modal.show();
      }

      function closeModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById("guestModal"));
        if (modal) {
          modal.hide();
        }
      }

      async function handleFormSubmit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const guestData = {
          name: formData.get("name"),
          email: formData.get("email"),
          phone: formData.get("phone") || undefined,
          date_of_birth: formData.get("date_of_birth") || undefined,
          country: formData.get("country") || undefined,
        };

        const guestId = formData.get("id");
        const isEdit = guestId && guestId !== "";

        const url = isEdit ? `${API_BASE}/guests/${guestId}` : `${API_BASE}/guests`;
        const method = isEdit ? "PUT" : "POST";

        try {
          const data = await apiCall(url, {
            method: method,
            body: JSON.stringify(guestData),
          });

          if (data.success) {
            showAlert(`Guest ${isEdit ? "updated" : "created"} successfully!`, "success");
            closeModal();
            // Clear cache and reload
            apiCache.clear();
            loadGuests(true);
          } else {
            throw new Error(data.error?.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error saving guest:", error);
          showAlert(`Error ${isEdit ? "updating" : "creating"} guest: ` + error.message, "error");
        }
      }

      async function deleteGuest(id) {
        if (!confirm("Are you sure you want to delete this guest?")) return;

        try {
          const data = await apiCall(`${API_BASE}/guests/${id}`, {
            method: "DELETE",
          });

          if (data.success) {
            showAlert("Guest deleted successfully!", "success");
            // Clear cache and reload
            apiCache.clear();
            loadGuests(true);
          } else {
            throw new Error(data.error?.message || "Unknown error");
          }
        } catch (error) {
          console.error("Error deleting guest:", error);
          showAlert("Error deleting guest: " + error.message, "error");
        }
      }

      function showAlert(message, type) {
        const alertContainer = document.getElementById("alertContainer");
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
          alertContainer.innerHTML = "";
        }, 5000);
      }

      // Form validation
      document.getElementById("guestForm").addEventListener("submit", function (event) {
        if (!this.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        this.classList.add("was-validated");
      });

      // Auto-hide alerts
      setTimeout(() => {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach((alert) => {
          alert.style.transition = "opacity 0.5s";
          alert.style.opacity = "0";
          setTimeout(() => alert.remove(), 500);
        });
      }, 5000);
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
